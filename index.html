<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
<title>PADDLE QUEST</title>
<link href="https://fonts.googleapis.com/css2?family=Lilita+One&display=swap" rel="stylesheet" />
<style>
  :root{ --bottom-safe: 28px; }

  html,body{
    margin:0; height:100%; background:#000; overflow:hidden;
    font-family:'Lilita One', cursive;
    -webkit-user-select:none; user-select:none; -webkit-touch-callout:none;
  }

  /* Fixed-size game stage for perfect fit */
  #gameContainer{
    position:relative; width:480px; height:720px; margin:0 auto; background:#000;
    touch-action:none;
  }
  #gameCanvas{
    position:absolute; inset:0; width:480px; height:720px; display:block;
    background:#000; image-rendering:pixelated;
  }

  /* Universal text look: white + black outline + shadow (as close to your spec) */
  .game-text{
    color:#fff;
    text-shadow: 0 2px 1px rgba(0,0,0,1);
    -webkit-text-stroke:1px #000;
  }

  .screen{
    position:absolute; inset:0; display:none; flex-direction:column; align-items:center;
    padding:40px 20px 20px; box-sizing:border-box; background:#000;
  }
  .screen.active{ display:flex; }
  .title{ font-size:60px; margin:6px 0 6px; }
  .subtitle{ font-size:22px; margin:0 0 24px; }

  .game-btn{
    width:360px; height:56px; margin:10px 0; border:none; border-radius:14px;
    font-size:28px; color:#000; background:#F5C518; cursor:pointer;
    box-shadow:0 3px 0 #b38f00, 0 6px 12px rgba(0,0,0,.35);
    font-family:'Lilita One', cursive;
  }
  .game-btn:active{ transform:translateY(2px); box-shadow:0 1px 0 #b38f00; }

  /* Back arrow */
  #backArrow{
    position:absolute; top:10px; left:10px; width:44px; height:44px;
    border:none; background:transparent; display:none; z-index:9999; cursor:pointer;
  }
  #backArrow svg{ width:100%; height:100%; fill:#fff; filter:drop-shadow(0 2px 2px #000); }

  /* Game Modes cards */
  .mode-card{
    width:420px; border:3px solid #F5C518; border-radius:18px; padding:18px; margin:10px 0 18px;
  }
  .mode-title{ font-size:32px; margin:0 0 6px; }
  .mode-desc{ font-size:18px; opacity:.9; }

  /* Missions list */
  #missionsList{ width:100%; max-width:420px; max-height:420px; overflow-y:auto; padding-right:6px; }
  .mission-item{ background:#1f1f1f; color:#fff; padding:12px 16px; margin:8px 0; border-radius:10px; font-size:20px; }
  .mission-item.completed{ background:#224f22; color:#9cff9c; text-decoration:line-through; }
  #missionsList::-webkit-scrollbar{ width:8px; }
  #missionsList::-webkit-scrollbar-thumb{ background:#444; border-radius:4px; }

  /* Pause overlay */
  #pauseScreen{
    position:absolute; inset:0; background:rgba(0,0,0,.86); display:none;
    align-items:center; justify-content:center; flex-direction:column; z-index:5000;
  }
  #pauseScreen .pause-text{ font-size:44px; margin-bottom:10px; }
  #pauseScreen .pause-subtext{ font-size:22px; }

  /* Challenge result overlay */
  #challengeResultScreen{
    position:absolute; inset:0; background:rgba(0,0,0,.92); display:none;
    align-items:center; justify-content:center; flex-direction:column; padding:30px 20px; z-index:6000;
  }
  #challengeResultScreen h2{ font-size:42px; margin:8px 0 16px; }
  #challengeResultScreen p{ font-size:26px; margin:0 0 20px; }
  #challengeResultScreen button{
    font-size:24px; padding:10px 26px; border-radius:12px; border:none; background:#F5C518; color:#000;
    cursor:pointer; font-family:'Lilita One', cursive;
  }

  /* HUD: Puddle Points (menus only) */
  #puddlePointsContainer{
    position:absolute; top:10px; right:12px; font-size:20px; z-index:2000;
  }

  /* Joystick-style bottom controls */
  #controlButtons{
    position:absolute; left:0; right:0; bottom:var(--bottom-safe); height:128px;
    display:flex; justify-content:space-between; align-items:center; padding:0 18px;
    box-sizing:border-box; z-index:3000; pointer-events:none;
  }
  .joy{
    pointer-events:auto; -webkit-tap-highlight-color:transparent; user-select:none;
    width:110px; height:110px; border-radius:55px;
    background:rgba(255,255,255,0.18);
    display:flex; align-items:center; justify-content:center;
    box-shadow: inset 0 0 0 3px rgba(245,197,24,0.9), 0 6px 16px rgba(0,0,0,.35);
    backdrop-filter: blur(2px);
  }
  .joy svg{ width:60px; height:60px; fill:#F5C518; pointer-events:none; }

  #midCluster{ display:flex; flex-direction:row; gap:18px; align-items:center; justify-content:center; }
  .mid{ width:100px; height:100px; border-radius:50px; }
  .controls-hidden #controlButtons{ display:none; }
</style>
</head>
<body>
  <div id="gameContainer" class="controls-hidden">
    <canvas id="gameCanvas" width="480" height="720"></canvas>

    <!-- HOME -->
    <div id="homeScreen" class="screen active">
      <div class="title game-text">Paddle Quest</div>
      <div class="subtitle game-text">Drag Puddle To Catch The Ball!</div>
      <button id="playBtn" class="game-btn">PLAY</button>
      <button id="gameModesBtn" class="game-btn">GAME MODES</button>
      <button id="missionsBtn" class="game-btn">MISSIONS</button>
      <button id="leaderboardBtn" class="game-btn">LEADERBOARDS</button>
    </div>

    <!-- MISSIONS -->
    <div id="missionsScreen" class="screen">
      <div class="title game-text">MISSIONS</div>
      <div id="missionsList"></div>
    </div>

    <!-- LEADERBOARD placeholder -->
    <div id="leaderboardScreen" class="screen">
      <div class="title game-text">COMING SOON!</div>
    </div>

    <!-- GAME MODES -->
    <div id="gameModesScreen" class="screen">
      <div class="title game-text">GAME MODES</div>

      <div class="mode-card">
        <div class="mode-title game-text">Endless Mode</div>
        <div class="mode-desc game-text">Play until you get bored.</div>
        <button class="game-btn" id="endlessPlayBtn">PLAY</button>
      </div>

      <div class="mode-card">
        <div class="mode-title game-text">60s Challenge</div>
        <div class="mode-desc game-text">
          Catch as many balls as you can in 60 seconds.<br />
          You can't lose early, but you can quit anytime.<br />
          Cost: 100 Puddle Points
        </div>
        <button class="game-btn" id="challengePlayBtn">PLAY</button>
      </div>
    </div>

    <!-- Back Arrow -->
    <button id="backArrow" title="Back">
      <svg viewBox="0 0 24 24"><path d="M15.41 7.41 14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
    </button>

    <!-- Pause overlay -->
    <div id="pauseScreen">
      <div class="pause-text game-text">Game Paused</div>
      <div class="pause-subtext game-text">Tap Anywhere To Continue</div>
    </div>

    <!-- Challenge result -->
    <div id="challengeResultScreen">
      <h2 id="challengeResultTitle" class="game-text"></h2>
      <p id="challengeFinalScore" class="game-text"></p>
      <button id="challengeResultBackBtn">Back</button>
    </div>

    <!-- HUD (menus only) -->
    <div id="puddlePointsContainer" class="game-text">
      Puddle Points: <span id="puddlePointsDisplay">0</span>
    </div>

    <!-- Joystick Controls -->
    <div id="controlButtons">
      <div id="leftArrow" class="joy" title="Left">
        <svg viewBox="0 0 24 24"><path d="M15.41 7.41 14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
      </div>

      <div id="midCluster">
        <div id="pauseBtn" class="joy mid" title="Pause">
          <svg viewBox="0 0 24 24">
            <rect x="6" y="5" width="4" height="14"></rect>
            <rect x="14" y="5" width="4" height="14"></rect>
          </svg>
        </div>
        <div id="homeBtn" class="joy mid" title="Home">
          <svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
        </div>
      </div>

      <div id="rightArrow" class="joy" title="Right">
        <svg viewBox="0 0 24 24"><path d="M8.59 16.59 13.17 12 8.59 7.41 10 6l6 6-6 6z"/></svg>
      </div>
    </div>
  </div>

<script>
(() => {
  const W=480,H=720;
  const container = document.getElementById('gameContainer');
  const canvas = document.getElementById('gameCanvas');
  const ctx = canvas.getContext('2d');

  /* ---------- Persistent ---------- */
  let highScore = parseInt(localStorage.getItem('paddleQuestHighScore')) || 0;
  let puddlePoints = parseInt(localStorage.getItem('puddlePoints')) || 0;

  /* ---------- UI Elements ---------- */
  const homeScreen = document.getElementById('homeScreen');
  const missionsScreen = document.getElementById('missionsScreen');
  const leaderboardScreen = document.getElementById('leaderboardScreen');
  const gameModesScreen = document.getElementById('gameModesScreen');

  const playBtn = document.getElementById('playBtn');
  const gameModesBtn = document.getElementById('gameModesBtn');
  const missionsBtn = document.getElementById('missionsBtn');
  const leaderboardBtn = document.getElementById('leaderboardBtn');

  const endlessPlayBtn = document.getElementById('endlessPlayBtn');
  const challengePlayBtn = document.getElementById('challengePlayBtn');

  const backArrow = document.getElementById('backArrow');

  const pauseScreen = document.getElementById('pauseScreen');
  const challengeResultScreen = document.getElementById('challengeResultScreen');
  const challengeResultTitle = document.getElementById('challengeResultTitle');
  const challengeFinalScore = document.getElementById('challengeFinalScore');
  const challengeResultBackBtn = document.getElementById('challengeResultBackBtn');

  const puddlePointsContainer = document.getElementById('puddlePointsContainer');
  const puddlePointsDisplay = document.getElementById('puddlePointsDisplay');

  const controlButtons = document.getElementById('controlButtons');
  const leftArrow = document.getElementById('leftArrow');
  const rightArrow = document.getElementById('rightArrow');
  const pauseBtn = document.getElementById('pauseBtn');
  const homeBtn = document.getElementById('homeBtn');

  /* ---------- Missions ---------- */
  const missionsList = document.getElementById('missionsList');
  const missions = [
    {id:1, desc:"Catch 10 balls", target:10, completed:false},
    {id:2, desc:"Catch 25 balls", target:25, completed:false},
    {id:3, desc:"Catch 50 balls", target:50, completed:false},
    {id:4, desc:"Play 3 games", target:3, completed:false},
    {id:5, desc:"Play 5 games", target:5, completed:false},
  ];
  let gamesPlayedCount = 0;

  function updatePuddlePointsDisplay(){ puddlePointsDisplay.textContent = String(puddlePoints); }
  function savePuddlePoints(){ localStorage.setItem('puddlePoints', String(puddlePoints)); }
  function renderMissions(){
    missionsList.innerHTML = '';
    missions.forEach(m=>{
      const d = document.createElement('div');
      d.className = 'mission-item game-text' + (m.completed?' completed':'');
      d.textContent = m.desc + (m.completed?' ✓':'');
      missionsList.appendChild(d);
    });
  }
  function updateMissionsOnStart(){
    gamesPlayedCount++;
    if(gamesPlayedCount>=3 && !missions[3].completed){ missions[3].completed=true; puddlePoints+=50; savePuddlePoints(); updatePuddlePointsDisplay(); }
    if(gamesPlayedCount>=5 && !missions[4].completed){ missions[4].completed=true; puddlePoints+=50; savePuddlePoints(); updatePuddlePointsDisplay(); }
    renderMissions();
  }
  function updateMissionsOnCatch(total){
    [1,2,3].forEach(idx=>{
      const m = missions[idx-1];
      if(!m.completed && total>=m.target){ m.completed=true; puddlePoints+=50; savePuddlePoints(); updatePuddlePointsDisplay(); }
    });
    renderMissions();
  }

  /* ---------- Gameplay ---------- */
  const paddle = { width:120, height:20, x:W/2-60, y:H-118, speed:9 };
  const ball   = { x:W/2, y:120, r:14, vx:5, vy:5 };
  let MAX_BALL_SPEED = 10;
  const CHALLENGE_BALL_SPEED = 6;

  let score=0, challengeScore=0, challengeTime=60;
  let currentMode=null; // 'endless' | 'challenge'
  let gameRunning=false, isPaused=false;

  let rafId = null; // to prevent loop stacking

  // parallax stars
  const stars=[];
  for(let i=0;i<90;i++){
    stars.push({x:Math.random()*W, y:Math.random()*H, s:Math.random()*2+1, v:Math.random()*0.6+0.3});
  }

  // particles
  const particles=[];
  class Particle{
    constructor(x,y){
      this.x=x; this.y=y;
      this.vx=(Math.random()-0.5)*3.2;
      this.vy=(Math.random()-0.5)*3.2;
      this.life=28+Math.random()*10;
      this.r=1.5+Math.random()*2.5;
    }
    update(){ this.x+=this.vx; this.y+=this.vy; this.vy+=0.02; this.life--; this.r*=0.98; }
    draw(){ ctx.fillStyle='#fff'; ctx.beginPath(); ctx.arc(this.x,this.y,Math.max(0,this.r),0,Math.PI*2); ctx.fill(); }
  }
  function spawnSparks(x,y,n=10){ for(let i=0;i<n;i++) particles.push(new Particle(x,y)); }

  function drawText(text,x,y,size=28,align='left'){
    ctx.save();
    ctx.font = `${size}px 'Lilita One', cursive`;
    ctx.textAlign = align;
    ctx.fillStyle = '#fff';
    ctx.shadowColor = '#000';
    ctx.shadowBlur = 1;
    ctx.shadowOffsetX = 0;
    ctx.shadowOffsetY = 2;
    ctx.lineWidth = 6;
    ctx.strokeStyle = '#000';
    ctx.strokeText(text,x,y);
    ctx.fillText(text,x,y);
    ctx.restore();
  }

  function drawStars(){
    ctx.fillStyle='#000'; ctx.fillRect(0,0,W,H);
    for(const st of stars){
      st.y += st.v; if(st.y>H) st.y=0;
      ctx.fillStyle='#fff'; ctx.beginPath(); ctx.arc(st.x,st.y,st.s,0,Math.PI*2); ctx.fill();
    }
  }

  function resetBallForMode(){
    if(currentMode==='challenge'){
      ball.vx = CHALLENGE_BALL_SPEED * (Math.random()<0.5?-1:1);
      ball.vy = CHALLENGE_BALL_SPEED;
    }else{
      ball.vx = 5 * (Math.random()<0.5?-1:1);
      ball.vy = 5;
    }
  }

  function resetGameCommon(){
    // cancel any previous loop to avoid stacking speeds
    if(rafId!==null){ cancelAnimationFrame(rafId); rafId=null; }

    score=0; challengeScore=0;
    paddle.x = W/2 - paddle.width/2; paddle.y = H - 118;
    ball.x=W/2; ball.y=120; resetBallForMode();
    isPaused=false; gameRunning=true;
  }

  /* ---------- Modes ---------- */
  let challengeTimerId=null;

  function startEndless(){
    currentMode='endless'; resetGameCommon(); updateMissionsOnStart();
    showGameplayUI(true); loop();
  }
  function startChallenge(){
    if(puddlePoints<100){ alert('Not enough Puddle Points! Complete missions to earn more.'); return; }
    puddlePoints -= 100; savePuddlePoints(); updatePuddlePointsDisplay();

    currentMode='challenge'; challengeTime=60; resetGameCommon(); updateMissionsOnStart();
    if(challengeTimerId) clearInterval(challengeTimerId);
    challengeTimerId = setInterval(()=>{
      if(isPaused) return;
      challengeTime--; if(challengeTime<=0){ clearInterval(challengeTimerId); endChallenge(true); }
    },1000);
    showGameplayUI(true); loop();
  }

  function endGame(){
    gameRunning=false;
    if(rafId!==null){ cancelAnimationFrame(rafId); rafId=null; }
    if(score>highScore){ highScore=score; localStorage.setItem('paddleQuestHighScore', String(highScore)); }
    alert(`Game Over! Your score: ${score}`);
    goHome();
  }

  function endChallenge(success){
    gameRunning=false;
    if(rafId!==null){ cancelAnimationFrame(rafId); rafId=null; }
    if(challengeTimerId){ clearInterval(challengeTimerId); challengeTimerId=null; }
    pauseScreen.style.display='none';
    if(success){
      challengeResultTitle.textContent='Challenge Completed!';
      challengeFinalScore.textContent=`Your Score: ${challengeScore}`;
      // Optional completion reward:
      puddlePoints += 50; savePuddlePoints(); updatePuddlePointsDisplay();
    }else{
      challengeResultTitle.textContent='Challenge Failed';
      challengeFinalScore.textContent='';
    }
    challengeResultScreen.style.display='flex';
  }

  /* ---------- Loop ---------- */
  function update(){
    if(!gameRunning || isPaused) return;

    // input
    if(leftHeld)  paddle.x -= paddle.speed;
    if(rightHeld) paddle.x += paddle.speed;
    if(paddle.x<0) paddle.x=0;
    if(paddle.x+paddle.width>W) paddle.x=W-paddle.width;

    // ball
    ball.x += ball.vx; ball.y += ball.vy;

    // walls
    if(ball.x+ball.r>W){ ball.x=W-ball.r; ball.vx*=-1; spawnSparks(ball.x,ball.y,8); }
    if(ball.x-ball.r<0){ ball.x=ball.r;   ball.vx*=-1; spawnSparks(ball.x,ball.y,8); }
    if(ball.y-ball.r<0){ ball.y=ball.r;   ball.vy*=-1; spawnSparks(ball.x,ball.y,8); }

    // paddle
    if(ball.y+ball.r>=paddle.y && ball.x>paddle.x && ball.x<paddle.x+paddle.width && ball.vy>0){
      ball.y = paddle.y - ball.r;
      ball.vy *= -1;
      spawnSparks(ball.x, ball.y, 12);

      // score + speed control
      if(currentMode==='challenge'){
        challengeScore++;
      }else{
        score++;
        if(Math.abs(ball.vx)<MAX_BALL_SPEED){ ball.vx*=1.05; ball.vy*=1.05; }
      }
      updateMissionsOnCatch(score);
    }

    // below bottom
    if(ball.y - ball.r > H){
      if(currentMode==='challenge'){
        // bounce back (can't lose early)
        ball.y = H - 160; ball.vy = -Math.abs(ball.vy);
      }else{
        endGame();
      }
    }

    // particles
    for(let i=particles.length-1;i>=0;i--){
      particles[i].update();
      if(particles[i].life<=0 || particles[i].r<=0.2){ particles.splice(i,1); }
    }
  }

  function draw(){
    drawStars();

    // paddle
    ctx.fillStyle='#F5C518';
    ctx.fillRect(paddle.x, paddle.y, paddle.width, paddle.height);

    // ball
    ctx.fillStyle='#fff';
    ctx.beginPath(); ctx.arc(ball.x, ball.y, ball.r, 0, Math.PI*2); ctx.fill();

    // particles
    for(const p of particles) p.draw();

    // HUD
    drawText(`High Score: ${highScore}`, W-10, 36, 26, 'right');
    if(currentMode==='endless'){
      drawText(`Score: ${score}`, 10, 36, 26, 'left');
    }else if(currentMode==='challenge'){
      drawText(`Time: ${challengeTime}s`, W/2, 36, 26, 'center');
      drawText(`Score: ${challengeScore}`, W/2, 68, 22, 'center');
    }
  }

  function loop(){
    if(!gameRunning) return;
    ctx.clearRect(0,0,W,H);
    update(); draw();
    rafId = requestAnimationFrame(loop);
  }

  /* ---------- Navigation / Screens ---------- */
  function showOnly(screen){
    [homeScreen, missionsScreen, leaderboardScreen, gameModesScreen].forEach(s=>{
      s.style.display='none'; s.classList.remove('active');
    });
    if(screen){
      screen.style.display='flex'; screen.classList.add('active');
      container.classList.add('controls-hidden');
      backArrow.style.display = (screen===homeScreen) ? 'none' : 'block';
      puddlePointsContainer.style.display = 'block'; // menus: show currency
    }else{
      // gameplay
      container.classList.remove('controls-hidden');
      backArrow.style.display='none';
      puddlePointsContainer.style.display = 'none'; // hide currency during gameplay
    }
    pauseScreen.style.display='none';
    challengeResultScreen.style.display='none';
  }
  function showGameplayUI(isGame){
    if(isGame){
      showOnly(null);
    }else{
      showOnly(homeScreen);
    }
  }
  function goHome(){
    currentMode=null;
    if(rafId!==null){ cancelAnimationFrame(rafId); rafId=null; }
    showOnly(homeScreen);
  }

  /* ---------- Input (hold to move) ---------- */
  let leftHeld=false, rightHeld=false;
  function bindHold(btn, on, off){
    const start = e=>{ e.preventDefault(); on(); };
    const end   = e=>{ e.preventDefault(); off(); };
    btn.addEventListener('touchstart', start, {passive:false});
    btn.addEventListener('touchend',   end,   {passive:false});
    btn.addEventListener('touchcancel',end,   {passive:false});
    btn.addEventListener('mousedown',  start);
    btn.addEventListener('mouseup',    end);
    btn.addEventListener('mouseleave', end);
  }
  bindHold(leftArrow, ()=>leftHeld=true,  ()=>leftHeld=false);
  bindHold(rightArrow,()=>rightHeld=true, ()=>rightHeld=false);

  pauseBtn.addEventListener('click', ()=>{
    if(!gameRunning) return;
    if(isPaused){ isPaused=false; pauseScreen.style.display='none'; loop(); }
    else{ isPaused=true; pauseScreen.style.display='flex'; }
  });
  pauseScreen.addEventListener('click', ()=>{
    if(isPaused){ isPaused=false; pauseScreen.style.display='none'; loop(); }
  });

  homeBtn.addEventListener('click', ()=>{
    if(currentMode==='challenge' && gameRunning){ endChallenge(false); }
    else{ goHome(); }
  });

  // Top buttons
  playBtn.addEventListener('click', ()=> startEndless());
  gameModesBtn.addEventListener('click', ()=> showOnly(gameModesScreen));
  missionsBtn.addEventListener('click', ()=>{ showOnly(missionsScreen); renderMissions(); });
  leaderboardBtn.addEventListener('click', ()=> showOnly(leaderboardScreen));

  endlessPlayBtn.addEventListener('click', ()=> startEndless());
  challengePlayBtn.addEventListener('click', ()=> startChallenge());

  backArrow.addEventListener('click', ()=> showOnly(homeScreen));
  challengeResultBackBtn.addEventListener('click', ()=>{
    challengeResultScreen.style.display='none'; goHome();
  });

  /* ---------- Init ---------- */
  function init(){
    updatePuddlePointsDisplay();
    renderMissions();
    showOnly(homeScreen);

    // Keep controls safely above bottom bars
    controlButtons.style.bottom =
      getComputedStyle(document.documentElement).getPropertyValue('--bottom-safe') || '28px';

    // Prevent scroll/drag side effects on touch
    ['leftArrow','rightArrow','pauseBtn','homeBtn'].forEach(id=>{
      document.getElementById(id).addEventListener('touchmove', e=>e.preventDefault(), {passive:false});
    });
  }
  init();

})();
</script>
</body>
</html>
